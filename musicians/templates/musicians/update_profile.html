{% extends 'core/base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block content %}

<div class="container " xmlns="http://www.w3.org/1999/html">
    <div class="row"></div>
    <div class="row"></div>

<div class="row valign-wrapper">
    <form action="" method="post" enctype="multipart/form-data" >
     <!--avatar form   -->
    <div class="col s7">
        {% if user.userprofile.avatar %}
             <img alt="Avatar" class="circle responsive-img" src="{{ user.userprofile.avatar.url }}" />
            {% else %}
            <img alt="Avatar" class="circle responsive-img" src="{% static 'core/img/0.jpg' %}" />
            {% endif %}

           {% csrf_token %}
           {{ avatar_form.as_p }}

          <button class="btn-floating btn-large waves-effect waves-light black" type="submit" name="action">
      <i class="material-icons">add</i></button>

    </div>
    <!--profile form-->
    <div class="col s5">
        {{ profile_form.as_p }}
    </div>

</div>

    <!--local form-->


<div class="row">
    <div class="col s5 offset-s7">

        <div>
        <span class="tooltipped" data-position="bottom" data-tooltip="Je suis lÃ ">Localisation :</span>
        <span>{{user.userprofile.town}}, {{user.userprofile.county_name}}</span>

        <input id="first" type="button" value="Change">
        </div>

        <div class="col s4 ">

          <div style="display: none" id="cp"  class = "row " >

            {{ local_form.code |add_label_class:"Code postal" }}
            {{ local_form.code|append_attr:"class:validate" }}
            <input id="send" type="button" value="send">
            </div>
            <div  style="display: none" id="town"  class = "row " >

            {{ local_form.town|append_attr:'class:tooltipped'|append_attr:'data-position:bottom'|append_attr:'data-tooltip :plus de villes' }}
            {{ local_form.county_name}}

                <input id="go" type="submit" value="go">
            <!--<button class="btn-floating btn-large waves-effect waves-light green" type="submit" >-->
            <!--<i class="material-icons">add</i></button>-->

            </div>
<!--|append_attr:'class:tooltipped'|append_attr:'data-position:bottom'|append_attr:'data-tooltip :plus de villes'-->

        </div>

 </div>
        </div>
      <!-- Modal Structure in case of a bad input cp -->
  <div id="bad_cp" class="modal">
    <div class="modal-content">
      <h4>Mauvais code postal</h4>
      <p>Veuillez le resaisir</p>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-green btn-flat">OK</a>
    </div>
  </div>
</form>

</div>
</div>

{% endblock %}

{% block script %}

<script>
$("#first").click(function() {

  $("#cp").show();
  $("#first").hide();
  $("#send").show();
  $('#send').click(function () {
      var $code = $('#id_code').val();
      // valid cp coder
      var $return = validateZip($code);
      if ($return === true) {
          var url = createURL($code);
          $.getJSON(
              url,
              function (data) {
                  // $.each(data, function (index, value) {
                  //     $("#id_town").append($("<option value=" +value.nom+" >" + value.nom + "</option>"));
                  //     $(document).ready(function () {
                  //         $('select').formSelect();
                  //     });
                  //     console.log(value.nom)
                  //     $('#id_county_name').val(value.departement.nom);
                  // });
                  $("#send").hide();
                  $("#town").show();
              });
      } else {
          // show the modal
          var elem = document.querySelector('.modal');
          var instance = M.Modal.init(elem);
          instance.open();
      }

        });

        });

//validate postal code

function validateZip(code){
	return (code.length!=5 || isNaN(code)) ? false : true;
}

//create an url
function createURL(code) {
    var baseURL = "https://geo.api.gouv.fr/communes?codePostal="
    var params = {
                    fields : 'nom,departement',
                    format : 'json',
                    geometry : 'centre'
        };
    return(baseURL+code+'&'+ $.param( params ))
}

// initialize the select choice
  $(document).ready(function(){
    $('select').formSelect();
  });

</script>
{% endblock %}