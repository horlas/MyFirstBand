{% extends 'core/base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block content %}

<div class="container " xmlns="http://www.w3.org/1999/html">
    <div class="row"></div>
    <div class="row"></div>

            {% if messages %}
        {% for message in messages %}
        <div {% if message.tags %} class="alert alert-{{ message.tags }} alert-dismissible fade show" {% endif %}>
        <span>{{ message }}</span>
        </div>
        {% endfor %}
        {% endif %}
<div class="row">
    <div class="col s1 offset-s11">
        <a href='{% url "musicians:profile" %}' class="waves-effect waves-light btn ">
            <i class="material-icons left">equalizer</i> Provwccbcbcfil </a>
    </div>
</div>

<div class="row valign-wrapper">

 <!--avatar form-->
 <div class="col s5">

    <form action='{% url "musicians:update_avatar" %}' method="post" enctype="multipart/form-data" >
        {% csrf_token %}


        {% if user.userprofile.avatar %}
             <img alt="Avatar" class="circle responsive-img" src="{{ user.userprofile.avatar.url }}" />
            {% else %}
            <img alt="Avatar" class="circle responsive-img" src="{% static 'core/img/0.jpg' %}" />
            {% endif %}


           {{ avatar_form.as_p }}

      <button class="btn-floating btn-large waves-effect waves-light " type="submit" >
      <i class="material-icons">check</i></button>
    </form>





</div>

    <!--profile form-->
<div class="col s7">
   <form action='{% url "musicians:update_data" %}' method="post"  >
       {% csrf_token %}


        {{ profile_form.as_p }}

         <button class="btn-floating btn-large waves-effect waves-light " type="submit" >
      <i class="material-icons">check</i></button>

    </form>
</div>

</div>

    <!--local form-->

 <div class="row">

 <div class="col s5 offset-s5">
    <form action='{% url "musicians:update_location" %}' method="post"  >
    {% csrf_token %}

        <div>
        <span class="tooltipped" data-position="bottom" data-tooltip="Je suis lÃ ">Localisation :</span>
        <span>{{user.userprofile.town}}, {{user.userprofile.county_name}}</span>


        </div>
        <input id="first" type="button" value="Change">
        <div class="col s4 ">

          <div style="display: none" id="cp"  class = "row " >

            {{ local_form.code |add_label_class:"Code postal" }}
            {{ local_form.code|append_attr:"class:validate" }}
            <input id="send" type="button" value="send">
            </div>
            <div  style="display: none" id="town"  class = "row " >

            {{ local_form.town }}
            {{ local_form.county_name}}

            <button class="btn-floating btn-large waves-effect waves-light " type="submit" >
            <i class="material-icons">check</i></button>

            </div>

<!--|append_attr:'class:tooltipped'|append_attr:'data-position:bottom'|append_attr:'data-tooltip :plus de villes'-->

        </div>

 </div>
     </form>
        </div>
      <!-- Modal Structure in case of a bad input cp -->
  <div id="bad_cp" class="modal">
    <div class="modal-content">
      <h4>Mauvais code postal</h4>
      <p>Veuillez le resaisir</p>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-green btn-flat">OK</a>
    </div>
  </div>

</div>




{% endblock %}

{% block script %}

<script>
$("#first").click(function() {

  $("#cp").show();
  $("#first").hide();
  $("#send").show();
  $('#send').click(function () {
      var $code = $('#id_code').val();
      // valid cp coder
      var $return = validateZip($code);
      if ($return === true) {
          var url = createURL($code);
          $.getJSON(
              url,
              function (data) {
                  $.each(data, function (index, value) {
                      $("#id_town").append($("<option value=" +value.nom+ ">" + value.nom + "</option>"));
                      $(document).ready(function () {
                          $('select').formSelect();
                      });
                      console.log(value.nom)
                      $('#id_county_name').val(value.departement.nom);
                  });
                  $("#send").hide();
                  $("#town").show();
              });
      } else {
          // show the modal
          var elem = document.querySelector('.modal');
          var instance = M.Modal.init(elem);
          instance.open();
      }

        });

        });

//validate postal code

function validateZip(code){
	return (code.length!=5 || isNaN(code)) ? false : true;
}

//create an url
function createURL(code) {
    var baseURL = "https://geo.api.gouv.fr/communes?codePostal="
    var params = {
                    fields : 'nom,departement',
                    format : 'json',
                    geometry : 'centre'
        };
    return(baseURL+code+'&'+ $.param( params ))
}

// initialize the select choice
  $(document).ready(function(){
    $('select').formSelect();
  });

</script>
{% endblock %}